<!DOCTYPE html>
<html lang="de" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Signing CalyxOS builds</title>
  <link rel="shortcut icon" type="image/png" href="/calyxos.org/assets/images/favicon.png">
  
  <meta name="description" content="Signing CalyxOS builds" />
  <link rel="stylesheet" href="/calyxos.org/assets/css/main.css">
  <link rel="alternate" type="application/rss+xml" title="CalyxOS" href="/calyxos.org/feed.xml">
</head>

  <body>
    <header>
  <div class="wrapper">
    <div class="logoMark emptyLogo"></div>
    <h1 class="logo"><a class="navbar-brand" href="/calyxos.org/de/">CalyxOS</a></h1>
    <nav class="navbar navbar-expand-sm">
      <input type="checkbox" class="toggle" id="navbar-visible"></input>
      <ul class="navbar-nav">
        <li class="nav-level-0 nav-item"><a class="nav-level-0 nav-link " href="/calyxos.org/de/features/">Features</a></li>
<li class="nav-level-0 nav-item"><a class="nav-level-0 nav-link " href="/calyxos.org/de/community/">Community</a></li>
<li class="nav-level-0 nav-item"><a class="nav-level-0 nav-link active" href="/calyxos.org/de/docs/">Documentation</a></li>
<li class="nav-level-0 nav-item"><a class="nav-level-0 nav-link " href="/calyxos.org/de/news/">News</a></li>
        <li><a role="button" class="btn primaryBtn" href="/calyxos.org/de/get">Get CalyxOS</a></li>
      </ul>
      <label class="toggle navbar-toggle" for="navbar-visible"></label>
    </nav>
  </div>
</header>

    <main>
      <section class="secondaryIntro">
        <div class="wrapper sidebar-spacing">
          <h1><span class="highlighter">Signing CalyxOS builds</span></h1>


        </div>
      </section>
      <div class="wrapper sidebar">
        <div class="navside">
  <ul class="">


<li class="nav-level-1 nav-item"><a class="nav-level-1 nav-link " href="/calyxos.org/de/docs/about/">About</a></li>
<li class="nav-level-1 nav-item"><a class="nav-level-1 nav-link " href="/calyxos.org/de/docs/guide/">User Guide</a></li>
<li class="nav-level-1 nav-item"><a class="nav-level-1 nav-link " href="/calyxos.org/de/docs/tech/">Tech</a></li>
<li class="nav-level-1 nav-item"><a class="nav-level-1 nav-link " href="/calyxos.org/de/docs/development/">Development</a></li><li class="nav-level-2 nav-item"><a class="nav-level-2 nav-link " href="/calyxos.org/de/docs/development/contribute/">Contribute</a></li>
<li class="nav-level-2 nav-item"><a class="nav-level-2 nav-link " href="/calyxos.org/de/docs/development/gerrit/">Gerrit</a></li>
<li class="nav-level-2 nav-item"><a class="nav-level-2 nav-link " href="/calyxos.org/de/docs/development/build/">Build</a></li><li class="nav-level-3 nav-item"><a class="nav-level-3 nav-link " href="/calyxos.org/de/docs/development/build/app-fdroid/">Build F-Droid</a></li>
<li class="nav-level-3 nav-item"><a class="nav-level-3 nav-link " href="/calyxos.org/de/docs/development/build/app-microg/">Build microG</a></li>
<li class="nav-level-3 nav-item"><a class="nav-level-3 nav-link " href="/calyxos.org/de/docs/development/build/chromium/">Build Chromium</a></li>
<li class="nav-level-3 nav-item"><a class="nav-level-3 nav-link " href="/calyxos.org/de/docs/development/build/emulator/">Emulator</a></li>
<li class="nav-level-3 nav-item"><a class="nav-level-3 nav-link " href="/calyxos.org/de/docs/development/build/kernel/">Build kernel</a></li>
<li class="nav-level-3 nav-item"><a class="nav-level-3 nav-link " href="/calyxos.org/de/docs/development/build/production/">Production</a></li>
<li class="nav-level-3 nav-item"><a class="nav-level-3 nav-link active" href="/calyxos.org/de/docs/development/build/sign/">Sign</a></li>

  </ul>
</div>

        <section class="content primaryContent">
          <div class="toc">
  <h2>Contents</h2>
  <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#build">Build</a></li>
<li class="toc-entry toc-h2"><a href="#generating-keys">Generating keys</a></li>
<li class="toc-entry toc-h2"><a href="#signing">Signing</a>
<ul>
<li class="toc-entry toc-h4"><a href="#sign-the-build">Sign the build</a></li>
<li class="toc-entry toc-h4"><a href="#generate-incremental-otas">Generate incremental OTAs</a></li>
<li class="toc-entry toc-h4"><a href="#generate-metadata-for-the-update-server">Generate metadata for the update server</a></li>
</ul>
</li>
</ul>
</div>

          <p>CalyxOS is built on a dedicated server and then signed separately. It can be signed on the same machine, but it has to be in a different directory.</p>

<h2 id="build">Build</h2>

<ul>
  <li>You need to have a <a href="/calyxos.org/de/docs/development/build/">build environment</a> setup first, and a build of CalyxOS.</li>
  <li>Choose ‘user’ when running <code class="language-plaintext highlighter-rouge">lunch</code>.</li>
  <li>For signing, you want to build a ‘target-files-package’ using <code class="language-plaintext highlighter-rouge">m target-files-package</code></li>
  <li>You’ll also want to build the tools needed for signing and key creation, <code class="language-plaintext highlighter-rouge">m otatools-package otatools-key-package</code></li>
</ul>

<p>Copy:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">$OUT/otatools.zip</code></li>
  <li><code class="language-plaintext highlighter-rouge">$OUT/obj/PACKAGING/target_files_intermediates/*.zip</code></li>
</ul>

<p>to a separate folder for signing.</p>

<p>Also copy:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">$OUT/otatools-keys.zip</code></li>
</ul>

<p>if you need to create the keys used to sign the OS.</p>

<h2 id="generating-keys">Generating keys</h2>

<p>If you’re signing CalyxOS for the first time, you will need to create the necessary keys.</p>

<p>You should unzip the ‘otatools-keys.zip’ from the above step, preferably on an offline machine.</p>

<p>Run:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">./vendor/calyx/scripts/mkkeys.sh</code> to generate the keys needed for all devices. Do not set a password as the signing scripts do not support that currently.</li>
</ul>

<p>If you’re building for the Mi A2 / <code class="language-plaintext highlighter-rouge">jasmine_sprout</code>, you should copy <code class="language-plaintext highlighter-rouge">keys/jasmine_sprout/verity.x509.pem</code> to <code class="language-plaintext highlighter-rouge">kernel/xiaomi/jasmine_sprout/certs/</code> in the CalyxOS source code and then rebuild.</p>

<p>Optionally, run:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">./vendor/calyx/scripts/mkcommonkeys.sh</code> to create some common keys used to sign apps. These will not be used by default, they are used to sign certain apps put into the OS such as Trichrome (Chromium) and F-Droid.</li>
</ul>

<h2 id="signing">Signing</h2>

<p>This assumes you’ve generated the keys as mentioned above.</p>

<p>In a folder, you should have ‘otatools.zip’, the ‘calyx_device-target-files.zip’, and ‘keys’. ‘keys’ can be a symlink.</p>

<h4 id="sign-the-build">Sign the build</h4>
<p>This will sign the build, and create ota update zips and factory images.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">BUILD_NUMBER</span><span class="o">=</span>eng.<span class="nv">$USERNAME</span>.date <span class="c"># Get this from the filename</span>
unzip otatools.zip
./vendor/calyx/scripts/release.sh sunfish calyx_sufnish-target_files-<span class="k">${</span><span class="nv">BUILD_NUMBER</span><span class="k">}</span>.zip <span class="c"># Replace sunfish with your device</span>
</code></pre></div></div>

<h4 id="generate-incremental-otas">Generate incremental OTAs</h4>
<p>If you have an older build, you should symlink that to ‘archive’, and then you can generate an incremental OTA using:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">PREV_BUILD_NUMBER</span><span class="o">=</span>eng.<span class="nv">$USERNAME</span>.prevdate <span class="c"># Get this from the filename</span>
./vendor/calyx/scripts/generate_delta.sh sunfish <span class="k">${</span><span class="nv">PREV_BUILD_NUMBER</span><span class="k">}</span> <span class="k">${</span><span class="nv">BUILD_NUMBER</span><span class="k">}</span> <span class="c"># Replace sunfish with your device</span>
</code></pre></div></div>

<h4 id="generate-metadata-for-the-update-server">Generate metadata for the update server</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/calyx/scripts/generate_metadata.py out/release-sunfish-<span class="k">${</span><span class="nv">BUILD_NUMBER</span><span class="k">}</span>/sunfish-ota_update-<span class="k">${</span><span class="nv">BUILD_NUMBER</span><span class="k">}</span>.zip <span class="c"># Replace sunfish with your device</span>
</code></pre></div></div>

<p><br /></p>

<p>References:</p>
<ul>
  <li><a href="https://source.android.com/devices/tech/ota/sign_builds">https://source.android.com/devices/tech/ota/sign_builds</a></li>
</ul>


        </section>
      </div>
    </main>
    <footer>
      
<div class="shade">
  <div class="wrapper">
    <div class="row">
      <a href="https://calyxinstitute.org/about">About Calyx</a>
      <span class="spacer" aria-hidden="true">&bull;</span>
      <a href="https://members.calyxinstitute.org/enroll/membership/phone">Join Calyx</a>
      <span class="spacer" aria-hidden="true">&bull;</span>
      <a href="https://calyxinstitute.org/about/contact-us">Contact Us</a>
      <span class="spacer" aria-hidden="true">&bull;</span>
      <a href="https://calyxinstitute.org/legal/privacy-policy">Privacy Policy</a>
      <span class="spacer" aria-hidden="true">&bull;</span>
      <a href="https://calyxinstitute.org/legal/terms-of-service">Terms of Service</a>
      <span class="spacer" aria-hidden="true">&bull;</span>
      <a href="https://members.calyxinstitute.org/donate">Donate</a>
    </div>
    <div class="row footer-icons">
      <a href="https://app.element.io/#/room/#calyxos:matrix.org" title="CalyxOS chat room">
        <img class="filter-grey" src="/calyxos.org/assets/images/icons/matrix.svg" />
      </a>
      <a href="https://gitlab.com/CalyxOS" title="CalyxOS source code">
        <img class="filter-grey" src="/calyxos.org/assets/images/icons/git.svg" />
      </a>
      <a href="https://twitter.com/CalyxOS" title="CalyxOS on Twitter">
        <img class="filter-grey" src="/calyxos.org/assets/images/icons/twitter.svg" />
      </a>
      <a href="https://reddit.com/r/CalyxOS" title="CalyxOS on Reddit">
        <img class="filter-grey" src="/calyxos.org/assets/images/icons/reddit.svg" />
      </a>
      <a href="https://facebook.com/calyxinstitute" title="Calyx Institute on Facebook">
        <img class="filter-grey" src="/calyxos.org/assets/images/icons/facebook.svg" />
      </a>
      <a href="https://instagram.com/calyxinsta" title="Calyx Institute on Instagram">
        <img class="filter-grey" src="/calyxos.org/assets/images/icons/instagram.svg" />
      </a>
    </div>
    <div class="row">
      <a href="https://calyxinstitute.org" target="_blank" rel="noreferrer nooopener">&copy; 2021 Calyx Institute</a>
    </div>
    <div class="row">
      <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer nofollow" title="License: Attribution-ShareAlike 4.0 International"><img class="filter-grey" style="height: 24px" src="/calyxos.org/assets/images/icons/cc-by-sa.svg" /></a>
    </div>
  </div>
</div>

    </footer>
  </body>
</html>
